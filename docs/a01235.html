<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>&#x202A;libpcl: &#x202A;Error System</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">&#x202A;libpcl
   </div>
   <div id="projectbrief">&#x202A;Portable C Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc PageDocLTR-title"><div class="header">
  <div class="headertitle">
<div class="title">&#x202A;Error System </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p class="DocNodeLTR">Error code mapping, stack traces and formatted error output.</p>
<p><a class="anchor" id="md__Users_andrew_projects_libpcl_doxygen_error"></a></p>
<p class="DocNodeLTR">The PCL error system provides a suite of functions across two modules: <a class="el" href="a01106.html">error</a> and <a class="el" href="a01105.html">errctx</a>. A primary design goal of PCL is to provide a robust error system.</p>
<p class="DocNodeLTR">The error system operates per-thread. Thread local storage (TLS) is used to maintain a per-thread <a class="el" href="a00104.html#a6a6ad7d51e43b622071669d0f39c1d4b">pcl_err_ctx_t</a>. So there is no global error context. Each thread is unique. To get the per-thread conetxt, use the <a class="el" href="a01106.html#gacba4bcf84db2e3237d7274aa57a30253" title="&#x202A;Gets the calling thread&#39;s error context.">pcl_err_ctx</a> function.</p>
<h1 class="DocNodeLTR"><a class="anchor" id="autotoc_md0"></a>
Error Codes</h1>
<p class="DocNodeLTR">PCL provides ~140 error codes. There are internal mapping tables to map Operating System error codes (oserr) to PCL. On unix systems, these mapping tables include all error codes defined in <code>errno.h</code>. On Windows, ~350 Win32 codes are mapped. In addition, there are also mappings for Windows CRT (POSIX errno.h support) to Win32.</p>
<p class="DocNodeLTR">All error code names begin with <code>PCL_E</code>. Most errors use the same naming as one would find in <code>errno.h:</code> <code>PCL_EINVAL</code>, <code>PCL_ENOENT</code>, <code>PCL_ERANGE</code>, <code>PCL_ENETRESET</code>, etc.</p>
<p class="DocNodeLTR">There are several public functions that leverage these mapping tables:</p>
<ul class="DocNodeLTR">
<li>&#x202A;<a class="el" href="a01106.html#gab532e2f49c5ec111bfc7e51575fa1b2d" title="&#x202A;Get the default PCL error message given an PCL error code.">pcl_err_msg</a> - looks up a PCL error code and returns the default error message</li>
<li>&#x202A;<a class="el" href="a01106.html#gad0fee080b336ed7ff879b61e72e0b8a9">pcl_err_name</a> - looks up a PCL error code and returns its name: <code>"PCL_EISDIR"</code> </li>
<li>&#x202A;<a class="el" href="a01106.html#ga6e488225c64979a7196c2b257c3c1fb0">pcl_err_code</a> - looks up a PCL error name and returns the PCL error code <br  />
</li>
<li>&#x202A;<a class="el" href="a01106.html#ga3ff5c98b765df74bd305d2e56e9b4f31">pcl_err_os2pcl</a> - looks up an OS error code and returns the PCL code</li>
<li>&#x202A;<a class="el" href="a01106.html#ga95d80f184621efe0108ec35ca590cd84">pcl_err_osname</a> - looks up an OS error code and returns its name: like Win32 <code>"ERROR_FILE_NOT_FOUND"</code> or Unix <code>"ENOENT"</code> </li>
<li>&#x202A;<a class="el" href="a01106.html#gac570ccdd8657267d758ed671b307bffd">pcl_err_osmsg</a> - looks up an OS error code and returns the default OS error message</li>
<li>&#x202A;<a class="el" href="a01106.html#ga3f3b9ad587c9b9160b1baaf06d5ffa12">pcl_err_crt2pcl</a> - For Windows, takes a CRT error code, like <code>EINTR</code>, and returns the PCL code, like <code>PCL_EINTR</code>. On Unix, the CRT error code is identical to the OS error code</li>
<li>&#x202A;<a class="el" href="a00413.html#a4c357e9c33e3ffa2fab31c76adc1eb03">pcl_err_crt2os</a> - For Windows, takes a CRT error code, like <code>EEXIST</code>, and returns the OS error code, like <code>ERROR_ALREADY_EXISTS</code>. On Unix, the CRT error code is identical to the OS error code</li>
</ul>
<h1 class="DocNodeLTR"><a class="anchor" id="autotoc_md1"></a>
Setting Errors</h1>
<p class="DocNodeLTR">Setting PCL errors typically involves using one of many macros. These macros all wrap the <a class="el" href="a01106.html#ga1fae5bebcb3cd7fc3fe889689f0c86a7">pcl_err_set</a> function, which internally uses the <a class="el" href="a01106.html#ga02bbc67e4c31e51f3f3b6ad389ba11a8">pcl_err_vset</a> function. These set functions are almost never used directly: they take many arguments including __FILE__, __func__, __LINE__, pcl error, os error, format string and variable arguments. The error set macros make setting an error easy. The set error macros all begin with <code>SETERR:</code> </p>
<ul class="DocNodeLTR">
<li>&#x202A;<a class="el" href="a01108.html#ga82adf6365b61d9a32021e559d9c31497" title="&#x202A;Sets the current thread&#39;s PCL error code.">SETERR</a> - sets the pcl error code</li>
<li>&#x202A;<a class="el" href="a01108.html#ga954df7afdee633aed0beba08add17f8c" title="&#x202A;Sets the current thread&#39;s PCL error code and OS error code.">SETERR_OS</a> - same as <code>SETERR</code> but also sets OS error code</li>
<li>&#x202A;<a class="el" href="a01108.html#ga7859a0a1a544c581d53bd7d44ab6805d" title="&#x202A;Sets the current thread&#39;s PCL error code and error message.">SETERRMSG</a> - sets the pcl error code and a formatted message</li>
<li>&#x202A;<a class="el" href="a01108.html#gaac6caa6459e4fae267aba35a8a24783b" title="&#x202A;Sets the current thread&#39;s PCL error code, OS error code and error message.">SETERRMSG_OS</a> - same as <code>SETERRMSG</code> but also sets OS error code</li>
<li>&#x202A;<a class="el" href="a01108.html#gaadc76b147014f17dcc08fa3c2f110a25" title="&#x202A;Sets the current thread&#39;s OS error code and maps code to PCL error code.">SETOSERR</a> - sets the os error code, internally mapped to PCL error code</li>
<li>&#x202A;<a class="el" href="a01108.html#ga2098ca75aa487e29880f176b7c717e98" title="&#x202A;Sets the current thread&#39;s OS error code, error message and maps code to PCL error code.">SETOSERRMSG</a> - same as <code>SETOSMSG</code> but includes formatted message</li>
<li>&#x202A;<a class="el" href="a01108.html#ga89b8bfbe17595305872551a1caaa5702" title="&#x202A;Sets the current thread&#39;s last OS error code and maps code to PCL error code.">SETLASTERR</a> - very common, sets the last OS error code. The os error code is the current Unix <code>errno</code> or for Windows, <code>GetLastError</code>, _doserrno or CRT <code>errno</code>. For any platform, you can use <a class="el" href="a01106.html#ga3646b2825d51326a06f25e597f883555">pcl_oserrno</a> to get the last OS error</li>
<li>&#x202A;<a class="el" href="a01108.html#ga405f0945f1e605ded867422c553c78cf" title="&#x202A;Sets the current thread&#39;s last OS error code.">SETLASTERRMSG</a> - same as <code>SETLASTERR</code> but includes a formatted message <br  />
</li>
</ul>
<p class="DocNodeLTR">All <code>SETERR*</code> macros expand to -1. If the error set is <a class="el" href="a01107.html#gad3b43ba0f3d97d535a1a3cf7fd8b35c2" title="&#x202A;The operation was successful.">PCL_EOKAY</a> (0), they expand to zero (almost never happens). By expanding to -1, <code>SETERR*</code> macros can be used with a <code>return</code> statement. This is by design, since most PCL functions return -1 to indicate an error. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> some_func(<span class="keyword">const</span> <span class="keywordtype">char</span> *str)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span>(str == NULL)</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="a01108.html#ga82adf6365b61d9a32021e559d9c31497">SETERR</a>(<a class="code" href="a01107.html#gae0cd5c5a7fae36cd480176bda17e77ca">PCL_EINVAL</a>); <span class="comment">// can also use BADARG() macro</span></div>
<div class="line">  <span class="keywordflow">return</span> (<span class="keywordtype">int</span>) strlen(str);</div>
<div class="line">}</div>
</div><!-- fragment --><p class="DocNodeLTR">As common as a -1 return value is to indicate an error, this is not always the case. A function may return any number of values or data types to indicate an error. For this reason, every <code>SETERR*</code> macro has a cooresponding <code>R_SETERR*</code> macro. These macros allowing setting the return value as the first argument to something other than -1. </p><div class="fragment"><div class="line"><span class="keywordtype">char</span> *some_func(<span class="keyword">const</span> <span class="keywordtype">char</span> *str)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span>(str == NULL)</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="a01108.html#gae8eaed12aa57a2870ad8e45cc2306318">R_SETERR</a>(NULL, <a class="code" href="a01107.html#gae0cd5c5a7fae36cd480176bda17e77ca">PCL_EINVAL</a>); </div>
<div class="line">  <span class="keywordflow">return</span> strdup(str);</div>
<div class="line">}</div>
</div><!-- fragment --><p class="DocNodeLTR">In the above case, we are not only setting the error but also indicating what value the macro should expand to &ndash; which is designed to be the return value; <code>R_</code> for return.</p>
<p class="DocNodeLTR">There are cases where after detecting an error, a set of cleanup functions need to be executed. In some cases, those cleanup functions may set the OS error code or even the PCL error code. The problem is that setting the error and returning may be the wrong error. To solve this issue, you can freeze the PCL error system using the <a class="el" href="a01108.html#ga5d0d174193729a18bb8a57d35a255229" title="&#x202A;Freeze the current thread&#39;s error context while executing code.">FREEZE_ERR</a> macro: </p><div class="fragment"><div class="line"><a class="code" href="a01214.html">pcl_file_t</a> *some_func(<a class="code" href="a01214.html">pcl_file_t</a> *file)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// another_func uses a SETERR* macro  </span></div>
<div class="line">  <span class="keywordflow">if</span>(another_func(file) &lt; 0)</div>
<div class="line">  {</div>
<div class="line">    <span class="comment">// preserve error set by another_func</span></div>
<div class="line">    <a class="code" href="a01108.html#ga5d0d174193729a18bb8a57d35a255229">FREEZE_ERR</a></div>
<div class="line">    (</div>
<div class="line">      <a class="code" href="a00056.html#ae06c73e0e7627c0e295c027c36d46442">pcl_file_seek</a>(file, 0, SEEK_SET); <span class="comment">// could set PCL error </span></div>
<div class="line">      etc..</div>
<div class="line">    );</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> file;</div>
<div class="line">}</div>
</div><!-- fragment --><h1 class="DocNodeLTR"><a class="anchor" id="autotoc_md2"></a>
Stack Trace</h1>
<p class="DocNodeLTR">PCL provides stack trace support, implemented as a linked list stack. When an error is set, PCL also adds a trace to the stack. There are two functions for adding to the current stack trace: <a class="el" href="a01106.html#ga30a9020e52ca985edcbd86e5b0676191">pcl_err_trace</a> and <a class="el" href="a01106.html#ga86913f06e1be53427513e88d829651ad">pcl_err_vtrace</a>. It is uncommon to use these functions directly for the same reason as the pcl error set functions: they are a pain to call directly. For this reason, there are four macros for adding a trace item to the stack: <a class="el" href="a01108.html#ga9ad3ef2339f58a873bc7bace5ad9c9df" title="&#x202A;Adds a stack trace to the current thread&#39;s error context.">TRC</a>, <a class="el" href="a01108.html#gac647173422caf7372229621b0aab81cd" title="&#x202A;Adds a stack trace to the current thread&#39;s error context with an error message.">TRCMSG</a>, <a class="el" href="a01108.html#gaa978c8c7faa5fc2f69a6641e054e519d" title="&#x202A;Sets the return value and adds a stack trace to the current thread&#39;s error context.">R_TRC</a> and <a class="el" href="a01108.html#gab7c6f91e3dd42d314f529e2177930dc3" title="&#x202A;Sets the return value and adds a stack trace to the current thread&#39;s error context with an error mess...">R_TRCMSG</a>. The <code>TRC</code> macro takes no arguments and expands to -1. <code>TRCMSG</code> is identical to <code>TRC</code> but allows setting a formatted trace message; great for adding context to the stack trace. The <code>R_TRC</code> and <code>R_TRCMSG</code> macros are identical to the non-R versions but just like <code>R_SETERR*</code> macros, take the expand/return value as the first argument.</p>
<p class="DocNodeLTR">In the previous example, <a class="el" href="a01108.html#ga5d0d174193729a18bb8a57d35a255229" title="&#x202A;Freeze the current thread&#39;s error context while executing code.">FREEZE_ERR</a> was used to avoid cleanup functions from overwriting the actual error. One thing that example failed to do, was add a trace. It can be rewritten as: </p><div class="fragment"><div class="line"><a class="code" href="a01214.html">pcl_file_t</a> *some_func(<a class="code" href="a01214.html">pcl_file_t</a> *file)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// another_func uses a SETERR* macro  </span></div>
<div class="line">  <span class="keywordflow">if</span>(another_func(file) &lt; 0)</div>
<div class="line">  {</div>
<div class="line">    <span class="comment">// preserve error set by another_func</span></div>
<div class="line">    <a class="code" href="a01108.html#ga5d0d174193729a18bb8a57d35a255229">FREEZE_ERR</a></div>
<div class="line">    (</div>
<div class="line">      <a class="code" href="a00056.html#ae06c73e0e7627c0e295c027c36d46442">pcl_file_seek</a>(file, 0, SEEK_SET); <span class="comment">// could set PCL error </span></div>
<div class="line">      etc..</div>
<div class="line">    );</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="a01108.html#gaa978c8c7faa5fc2f69a6641e054e519d">R_TRC</a>(NULL); <span class="comment">// add to stack trace</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> file;</div>
<div class="line">}</div>
</div><!-- fragment --><p class="DocNodeLTR">This is very useful, especially if <code>another_func</code> is called from many different places. Adding a trace via <code><a class="el" href="a01108.html#gaa978c8c7faa5fc2f69a6641e054e519d" title="&#x202A;Sets the return value and adds a stack trace to the current thread&#39;s error context.">R_TRC(NULL)</a></code>, tells us exactly how we got to the error call site.</p>
<p class="DocNodeLTR">Stack tracing is obviously opt-in. If you don't use the tracing macros, then you will only get the error call site trace information. A rule of thumb is, if the function you are calling is known to set the PCL error, then you want to set a trace. If the function, such as a function outside the PCL library, doesn't set the PCL error than use a <code>SETERR*</code> macro to begin the stack trace. So, tracing is not only opt-in but it is important to know what, if any, error handling was implemented by the function that failed. This is normally pretty straightforward. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="aa01108_html_gaa978c8c7faa5fc2f69a6641e054e519d"><div class="ttname"><a href="a01108.html#gaa978c8c7faa5fc2f69a6641e054e519d">R_TRC</a></div><div class="ttdeci">#define R_TRC(_retval)</div><div class="ttdoc">Sets the return value and adds a stack trace to the current thread's error context.</div><div class="ttdef"><b>Definition:</b> <a href="a00017_source.html#l00287">_errdefs.h:287</a></div></div>
<div class="ttc" id="aa01108_html_ga5d0d174193729a18bb8a57d35a255229"><div class="ttname"><a href="a01108.html#ga5d0d174193729a18bb8a57d35a255229">FREEZE_ERR</a></div><div class="ttdeci">#define FREEZE_ERR(code_fragment)</div><div class="ttdoc">Freeze the current thread's error context while executing code.</div><div class="ttdef"><b>Definition:</b> <a href="a00017_source.html#l00053">_errdefs.h:53</a></div></div>
<div class="ttc" id="aa01108_html_ga82adf6365b61d9a32021e559d9c31497"><div class="ttname"><a href="a01108.html#ga82adf6365b61d9a32021e559d9c31497">SETERR</a></div><div class="ttdeci">#define SETERR(_pclerr)</div><div class="ttdoc">Sets the current thread's PCL error code.</div><div class="ttdef"><b>Definition:</b> <a href="a00017_source.html#l00065">_errdefs.h:65</a></div></div>
<div class="ttc" id="aa00056_html_ae06c73e0e7627c0e295c027c36d46442"><div class="ttname"><a href="a00056.html#ae06c73e0e7627c0e295c027c36d46442">pcl_file_seek</a></div><div class="ttdeci">PCL_EXPORT off_t pcl_file_seek(pcl_file_t *file, off_t offset, int whence)</div><div class="ttdef"><b>Definition:</b> <a href="a00458_source.html#l00036">file_seek.c:36</a></div></div>
<div class="ttc" id="aa01214_html"><div class="ttname"><a href="a01214.html">tag_pcl_file</a></div><div class="ttdef"><b>Definition:</b> <a href="a00437_source.html#l00061">_file.h:62</a></div></div>
<div class="ttc" id="aa01108_html_gae8eaed12aa57a2870ad8e45cc2306318"><div class="ttname"><a href="a01108.html#gae8eaed12aa57a2870ad8e45cc2306318">R_SETERR</a></div><div class="ttdeci">#define R_SETERR(_retval, _pclerr)</div><div class="ttdoc">Sets the return value and the current thread's PCL error code.</div><div class="ttdef"><b>Definition:</b> <a href="a00017_source.html#l00145">_errdefs.h:145</a></div></div>
<div class="ttc" id="aa01107_html_gae0cd5c5a7fae36cd480176bda17e77ca"><div class="ttname"><a href="a01107.html#gae0cd5c5a7fae36cd480176bda17e77ca">PCL_EINVAL</a></div><div class="ttdeci">#define PCL_EINVAL</div><div class="ttdoc">Invalid argument.</div><div class="ttdef"><b>Definition:</b> <a href="a00020_source.html#l00078">_errno.h:78</a></div></div>
<!-- HTML footer for doxygen 1.8.20-->
<!-- start footer part -->
</body>
</html>
